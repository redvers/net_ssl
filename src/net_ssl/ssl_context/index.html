



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://ponylang.github.io/net_ssl/src/net_ssl/ssl_context/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/logo.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-ponylang-0.2.8">
    
    
      
        <title>Ssl context - net_ssl</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.b80b25f7.css">
      
    
    
      <script src="../../../assets/javascripts/modernizr.0b5df86e.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://ponylang.github.io/net_ssl/" title="net_ssl" class="md-header-nav__button md-logo">
          
            <img src="../../../assets/images/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                net_ssl
              </span>
              <span class="md-header-nav__topic">
                Ssl context
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <span class="md-nav__button md-logo">
      
        <img src="../../../assets/images/logo.png" width="48" height="48">
      
    </span>
    net_ssl
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="net_ssl" class="md-nav__link">
      net_ssl
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      package net_ssl
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        package net_ssl
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl--index/" title="Package" class="md-nav__link">
      Package
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-X509/" title="primitive X509" class="md-nav__link">
      primitive X509
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-SslAutoVersion/" title="primitive SslAutoVersion" class="md-nav__link">
      primitive SslAutoVersion
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-Ssl3Version/" title="primitive Ssl3Version" class="md-nav__link">
      primitive Ssl3Version
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-Tls1Version/" title="primitive Tls1Version" class="md-nav__link">
      primitive Tls1Version
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-Tls1u1Version/" title="primitive Tls1u1Version" class="md-nav__link">
      primitive Tls1u1Version
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-Tls1u2Version/" title="primitive Tls1u2Version" class="md-nav__link">
      primitive Tls1u2Version
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-Tls1u3Version/" title="primitive Tls1u3Version" class="md-nav__link">
      primitive Tls1u3Version
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-Dtls1Version/" title="primitive Dtls1Version" class="md-nav__link">
      primitive Dtls1Version
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-Dtls1u2Version/" title="primitive Dtls1u2Version" class="md-nav__link">
      primitive Dtls1u2Version
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-TlsMinVersion/" title="primitive TlsMinVersion" class="md-nav__link">
      primitive TlsMinVersion
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-TlsMaxVersion/" title="primitive TlsMaxVersion" class="md-nav__link">
      primitive TlsMaxVersion
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-DtlsMinVersion/" title="primitive DtlsMinVersion" class="md-nav__link">
      primitive DtlsMinVersion
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-DtlsMaxVersion/" title="primitive DtlsMaxVersion" class="md-nav__link">
      primitive DtlsMaxVersion
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-SSLContext/" title="class SSLContext" class="md-nav__link">
      class SSLContext
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-SSLConnection/" title="class SSLConnection" class="md-nav__link">
      class SSLConnection
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-SSLHandshake/" title="primitive SSLHandshake" class="md-nav__link">
      primitive SSLHandshake
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-SSLAuthFail/" title="primitive SSLAuthFail" class="md-nav__link">
      primitive SSLAuthFail
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-SSLReady/" title="primitive SSLReady" class="md-nav__link">
      primitive SSLReady
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-SSLError/" title="primitive SSLError" class="md-nav__link">
      primitive SSLError
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-SSLState/" title="type SSLState" class="md-nav__link">
      type SSLState
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-SSL/" title="class SSL" class="md-nav__link">
      class SSL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-ALPNProtocolNotify/" title="interface ALPNProtocolNotify" class="md-nav__link">
      interface ALPNProtocolNotify
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-ALPNProtocolName/" title="type ALPNProtocolName" class="md-nav__link">
      type ALPNProtocolName
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-ALPNFatal/" title="primitive ALPNFatal" class="md-nav__link">
      primitive ALPNFatal
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-ALPNNoAck/" title="primitive ALPNNoAck" class="md-nav__link">
      primitive ALPNNoAck
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-ALPNWarning/" title="primitive ALPNWarning" class="md-nav__link">
      primitive ALPNWarning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-ALPNMatchResult/" title="type ALPNMatchResult" class="md-nav__link">
      type ALPNMatchResult
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-ALPNProtocolResolver/" title="interface ALPNProtocolResolver" class="md-nav__link">
      interface ALPNProtocolResolver
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../net_ssl-ALPNStandardProtocolResolver/" title="class ALPNStandardProtocolResolver" class="md-nav__link">
      class ALPNStandardProtocolResolver
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Ssl context</h1>
                
                <pre><code class="language-pony-full-source">use &quot;files&quot;

use &quot;lib:crypt32&quot; if windows
use &quot;lib:cryptui&quot; if windows

use @memcpy[Pointer[U8]](dst: Pointer[None], src: Pointer[None], n: USize)
use @SSL_CTX_ctrl[ILong](
  ctx: Pointer[_SSLContext] tag,
  op: I32,
  arg: ULong,
  parg: Pointer[None])
use @SSLv23_method[Pointer[None]]() if &quot;openssl_0.9.0&quot;
use @TLS_method[Pointer[None]]() if &quot;openssl_1.1.x&quot;
use @SSL_CTX_new[Pointer[_SSLContext]](method: Pointer[None])
use @SSL_CTX_free[None](ctx: Pointer[_SSLContext] tag)
use @SSL_CTX_clear_options[ULong](ctx: Pointer[_SSLContext] tag, opts: ULong) if &quot;openssl_1.1.x&quot;
use @SSL_CTX_set_options[ULong](ctx: Pointer[_SSLContext] tag, opts: ULong) if &quot;openssl_1.1.x&quot;
use @SSL_CTX_use_certificate_chain_file[I32](ctx: Pointer[_SSLContext] tag, file: Pointer[U8] tag)
use @SSL_CTX_use_PrivateKey_file[I32](ctx: Pointer[_SSLContext] tag, file: Pointer[U8] tag, typ: I32)
use @SSL_CTX_check_private_key[I32](ctx: Pointer[_SSLContext] tag)
use @SSL_CTX_load_verify_locations[I32](ctx: Pointer[_SSLContext] tag, ca_file: Pointer[U8] tag,
  ca_path: Pointer[U8] tag)
use @X509_STORE_new[Pointer[U8] tag]()
use @CertOpenSystemStoreA[Pointer[U8] tag](prov: Pointer[U8] tag, protcol: Pointer[U8] tag)
  if windows
use @CertEnumCertificatesInStore[NullablePointer[_CertContext]](cert_store: Pointer[U8] tag,
  prev_ctx: NullablePointer[_CertContext]) if windows
use @d2i_X509[Pointer[X509] tag](val_out: Pointer[U8] tag, der_in: Pointer[Pointer[U8]],
  length: U32)
use @X509_STORE_add_cert[U32](store: Pointer[U8] tag, x509: Pointer[X509] tag)
use @X509_free[None](x509: Pointer[X509] tag)
use @SSL_CTX_set_cert_store[None](ctx: Pointer[_SSLContext] tag, store: Pointer[U8] tag)
use @X509_STORE_free[None](store: Pointer[U8] tag)
use @CertCloseStore[Bool](store: Pointer[U8] tag, flags: U32) if windows
use @SSL_CTX_set_cipher_list[I32](ctx: Pointer[_SSLContext] tag, control: Pointer[U8] tag)
use @SSL_CTX_set_verify_depth[None](ctx: Pointer[_SSLContext] tag, depth: U32)
use @SSL_CTX_set_alpn_select_cb[None](ctx: Pointer[_SSLContext] tag, cb: _ALPNSelectCallback,
   resolver: ALPNProtocolResolver) if &quot;openssl_1.1.x&quot;
use @SSL_CTX_set_alpn_protos[I32](ctx: Pointer[_SSLContext] tag, protos: Pointer[U8] tag,
  protos_len: USize) if &quot;openssl_1.1.x&quot;

primitive _SSLContext

primitive _SslCtrlSetOptions   fun val apply(): I32 =&gt; 32
primitive _SslCtrlClearOptions fun val apply(): I32 =&gt; 77

// These are the SSL_OP_NO_{SSL|TLS}vx{_x} in ssl.h.
// Since Pony doesn't allow underscore we use camel case
// and began them with underscore to keep them private.
// Also, in the version strings the &quot;v&quot; becomes &quot;V&quot; and
// the underscore &quot;_&quot; becomes &quot;u&quot;. So SSL_OP_NO_TLSv1_2
// _SslOpNo_TlsV1u2.
primitive _SslOpNoSslV2    fun val apply(): ULong =&gt; 0x01000000 // 0 in 1.1
primitive _SslOpNoSslV3    fun val apply(): ULong =&gt; 0x02000000
primitive _SslOpNoTlsV1    fun val apply(): ULong =&gt; 0x04000000
primitive _SslOpNoTlsV1u2  fun val apply(): ULong =&gt; 0x08000000
primitive _SslOpNoTlsV1u1  fun val apply(): ULong =&gt; 0x10000000
primitive _SslOpNoTlsV1u3  fun val apply(): ULong =&gt; 0x20000000

primitive _SslOpNoDtlsV1   fun val apply(): ULong =&gt; 0x04000000
primitive _SslOpNoDtlsV1u2 fun val apply(): ULong =&gt; 0x08000000

// Defined as SSL_OP_NO_SSL_MASK in ssl.h
primitive _SslOpNoSslMask
  fun val apply(): ULong =&gt;
    _SslOpNoSslV3() + _SslOpNoTlsV1() + _SslOpNoTlsV1u1() + _SslOpNoTlsV1u2()
      + _SslOpNoTlsV1u3()

// Defined as SSL_OP_NO_DTLS_MASK in ssl.h
primitive _SslOpNoDtlsMask
  fun val apply(): ULong =&gt; _SslOpNoDtlsV1() + _SslOpNoDtlsV1u2()

class val SSLContext
  &quot;&quot;&quot;
  An SSL context is used to create SSL sessions.
  &quot;&quot;&quot;
  var _ctx: Pointer[_SSLContext] tag
  var _client_verify: Bool = true
  var _server_verify: Bool = false

  new create() =&gt;
    &quot;&quot;&quot;
    Create an SSL context.
    &quot;&quot;&quot;
    ifdef &quot;openssl_1.1.x&quot; then
      _ctx = @SSL_CTX_new(@TLS_method())

      // Allow only newer ciphers.
      try
        set_min_proto_version(Tls1u2Version())?
        set_max_proto_version(SslAutoVersion())?
      end
    elseif &quot;openssl_0.9.0&quot; then
      _ctx = @SSL_CTX_new(@SSLv23_method())

      // Disable &quot;all&quot; SSL/TSL options
      _set_options(_SslOpNoSslMask() + _SslOpNoSslV2())

      // Allow only newer ciphers
      allow_tls_v1_2(true)
    else
      compile_error &quot;You must select an SSL version to use.&quot;
    end

  fun _set_options(opts: ULong) =&gt;
    ifdef &quot;openssl_1.1.x&quot; then
      @SSL_CTX_set_options(_ctx, opts)
    elseif &quot;openssl_0.9.0&quot; then
      @SSL_CTX_ctrl(_ctx, _SslCtrlSetOptions(), opts, Pointer[None])
    else
      compile_error &quot;You must select an SSL version to use.&quot;
    end

  fun _clear_options(opts: ULong) =&gt;
    ifdef &quot;openssl_1.1.x&quot; then
      @SSL_CTX_clear_options(_ctx, opts)
    elseif &quot;openssl_0.9.0&quot; then
      @SSL_CTX_ctrl(_ctx, _SslCtrlClearOptions(), opts, Pointer[None])
    else
      compile_error &quot;You must select an SSL version to use.&quot;
    end

  fun client(hostname: String = &quot;&quot;): SSL iso^ ? =&gt;
    &quot;&quot;&quot;
    Create a client-side SSL session. If a hostname is supplied, the server
    side certificate must be valid for that hostname.
    &quot;&quot;&quot;
    let ctx = _ctx
    let verify = _client_verify
    recover SSL._create(ctx, false, verify, hostname)? end

  fun server(): SSL iso^ ? =&gt;
    &quot;&quot;&quot;
    Create a server-side SSL session.
    &quot;&quot;&quot;
    let ctx = _ctx
    let verify = _server_verify
    recover SSL._create(ctx, true, verify)? end

  fun ref set_cert(cert: FilePath, key: FilePath) ? =&gt;
    &quot;&quot;&quot;
    The cert file is a PEM certificate chain. The key file is a private key.
    Servers must set this. For clients, it is optional.
    &quot;&quot;&quot;
    if
      _ctx.is_null()
        or (cert.path.size() == 0)
        or (key.path.size() == 0)
        or (0 == @SSL_CTX_use_certificate_chain_file(
          _ctx, cert.path.cstring()))
        or (0 == @SSL_CTX_use_PrivateKey_file(
          _ctx, key.path.cstring(), I32(1)))
        or (0 == @SSL_CTX_check_private_key(_ctx))
    then
      error
    end

  fun ref set_authority(
    file: (FilePath | None),
    path: (FilePath | None) = None)
    ?
  =&gt;
    &quot;&quot;&quot;
    Use a PEM file and/or a directory of PEM files to specify certificate
    authorities. Clients must set this. For servers, it is optional. Use None
    to indicate no file or no path. Raises an error if these verify locations
    aren't valid.

    If both `file` and `path` are `None`, on Windows this method loads the
    system root certificates. On Posix it raises an error.
    &quot;&quot;&quot;
    if (file is None) and (path is None) then
      ifdef windows then
        _load_windows_root_certs()?
      else
        error
      end
    else
      let fs = try (file as FilePath).path else &quot;&quot; end
      let ps = try (path as FilePath).path else &quot;&quot; end

      let f = if fs.size() &gt; 0 then fs.cstring() else Pointer[U8] end
      let p = if ps.size() &gt; 0 then ps.cstring() else Pointer[U8] end

      if
        _ctx.is_null()
          or (f.is_null() and p.is_null())
          or (0 == @SSL_CTX_load_verify_locations(_ctx, f, p))
      then
        error
      end
    end

  fun ref _load_windows_root_certs() ? =&gt;
    ifdef windows then
      let root_str = &quot;ROOT&quot;
      let hStore = @CertOpenSystemStoreA(Pointer[U8], root_str.cstring())
      if hStore.is_null() then error end

      let x509_store = @X509_STORE_new()
      if x509_store.is_null() then error end

      try
        var pContext: NullablePointer[_CertContext]
        pContext =
          @CertEnumCertificatesInStore(hStore, NullablePointer[_CertContext].none())

        while not pContext.is_none() do
          let cert_context = pContext()?
          let x509 = @d2i_X509(Pointer[U8], addressof cert_context.pbCertEncoded,
            cert_context.cbCertEncoded)
          if not x509.is_null() then
            let result = @X509_STORE_add_cert(x509_store, x509)
            @X509_free(x509)
            if result != 1 then error end
          end

          pContext = @CertEnumCertificatesInStore(hStore, pContext)
        end

        @SSL_CTX_set_cert_store(_ctx, x509_store)
      else
        @X509_STORE_free(x509_store)
      then
        @CertCloseStore(hStore, U32(0))
      end
    end

  fun ref set_ciphers(ciphers: String) ? =&gt;
    &quot;&quot;&quot;
    Set the accepted ciphers. This replaces the existing list. Raises an error
    if the cipher list is invalid.
    &quot;&quot;&quot;
    if
      _ctx.is_null()
        or (0 == @SSL_CTX_set_cipher_list(_ctx, ciphers.cstring()))
    then
      error
    end

  fun ref set_client_verify(state: Bool) =&gt;
    &quot;&quot;&quot;
    Set to true to require verification. Defaults to true.
    &quot;&quot;&quot;
    _client_verify = state

  fun ref set_server_verify(state: Bool) =&gt;
    &quot;&quot;&quot;
    Set to true to require verification. Defaults to false.
    &quot;&quot;&quot;
    _server_verify = state

  fun ref set_verify_depth(depth: U32) =&gt;
    &quot;&quot;&quot;
    Set the verify depth. Defaults to 6.
    &quot;&quot;&quot;
    if not _ctx.is_null() then
      @SSL_CTX_set_verify_depth(_ctx, depth)
    end

  fun ref set_min_proto_version(version: ULong) ? =&gt;
    &quot;&quot;&quot;
    Set minimum protocol version. Set to SslAutoVersion, 0,
    to automatically manage lowest version.

    Supported versions: Ssl3Version, Tls1Version, Tls1u1Version,
                        Tls1u2Version, Tls1u3Version, Dtls1Version,
                        Dtls1u2Version
    &quot;&quot;&quot;
    let result =
      @SSL_CTX_ctrl(_ctx, _SslCtrlSetMinProtoVersion(), version, Pointer[None])
    if result == 0 then
      error
    end

  fun ref get_min_proto_version(): ILong =&gt;
    &quot;&quot;&quot;
    Get minimum protocol version. Returns SslAutoVersion, 0,
    when automatically managing lowest version.

    Supported versions: Ssl3Version, Tls1Version, Tls1u1Version,
                        Tls1u2Version, Tls1u3Version, Dtls1Version,
                        Dtls1u2Version
    &quot;&quot;&quot;
    @SSL_CTX_ctrl(_ctx, _SslCtrlGetMinProtoVersion(), 0, Pointer[None])

  fun ref set_max_proto_version(version: ULong) ? =&gt;
    &quot;&quot;&quot;
    Set maximum protocol version. Set to SslAutoVersion, 0,
    to automatically manage higest version.

    Supported versions: Ssl3Version, Tls1Version, Tls1u1Version,
                        Tls1u2Version, Tls1u3Version, Dtls1Version,
                        Dtls1u2Version
    &quot;&quot;&quot;
    let result =
      @SSL_CTX_ctrl(_ctx, _SslCtrlSetMaxProtoVersion(), version, Pointer[None])
    if result == 0 then
      error
    end

  fun ref get_max_proto_version(): ILong =&gt;
    &quot;&quot;&quot;
    Get maximum protocol version. Returns SslAutoVersion, 0,
    when automatically managing highest version.

    Supported versions: Ssl3Version, Tls1Version, Tls1u1Version,
                        Tls1u2Version, Tls1u3Version, Dtls1Version,
                        Dtls1u2Version
    &quot;&quot;&quot;
    @SSL_CTX_ctrl(_ctx, _SslCtrlGetMaxProtoVersion(), 0, Pointer[None])

  fun ref alpn_set_resolver(resolver: ALPNProtocolResolver box): Bool =&gt;
    &quot;&quot;&quot;
    Use `resolver` to choose the protocol to be selected for incomming connections.

    Returns true on success
    Requires OpenSSL &gt;= 1.0.2
    &quot;&quot;&quot;
    ifdef &quot;openssl_1.1.x&quot; then
      @SSL_CTX_set_alpn_select_cb(
        _ctx, addressof SSLContext._alpn_select_cb, resolver)
      return true
    elseif &quot;openssl_0.9.0&quot; then
      return false
    else
      compile_error &quot;You must select an SSL version to use.&quot;
    end

  fun ref alpn_set_client_protocols(protocols: Array[String] box): Bool =&gt;
    &quot;&quot;&quot;
    Configures the SSLContext to advertise the protocol names defined in `protocols` when connecting to a server
    protocol names must have a size of 1 to 255

    Returns true on success
    Requires OpenSSL &gt;= 1.0.2
    &quot;&quot;&quot;
    ifdef &quot;openssl_1.1.x&quot; then
      try
        let proto_list = _ALPNProtocolList.from_array(protocols)?
        let result =
          @SSL_CTX_set_alpn_protos(
            _ctx, proto_list.cpointer(), proto_list.size())
        return result == 0
      end
    elseif &quot;openssl_0.9.0&quot; then
      return false
    else
      compile_error &quot;You must select an SSL version to use.&quot;
    end

    false

  fun @_alpn_select_cb(
    ssl: Pointer[_SSL] tag,
    out: Pointer[Pointer[U8] tag] tag,
    outlen: Pointer[U8] tag,
    inptr: Pointer[U8] box,
    inlen: U32,
    resolver: ALPNProtocolResolver box)
    : I32
  =&gt;
    let proto_arr_str = String.copy_cpointer(inptr, USize.from[U32](inlen))
    try
      let proto_arr = _ALPNProtocolList.to_array(proto_arr_str)?

      match resolver.resolve(proto_arr)
      | let matched: String =&gt;
      var size = matched.size()
      if (size &gt; 0) and (size &lt;= 255) then
        var ptr = matched.cpointer()
        @memcpy(out, addressof ptr, size.bitwidth() / 8)
        @memcpy(outlen, addressof size, USize(1))
        _ALPNMatchResultCode.ok()
      else
        _ALPNMatchResultCode.fatal()
      end
      | ALPNNoAck =&gt; _ALPNMatchResultCode.no_ack()
      | ALPNWarning =&gt; _ALPNMatchResultCode.warning()
      | ALPNFatal =&gt; _ALPNMatchResultCode.fatal()
      end
    else
      _ALPNMatchResultCode.fatal()
    end

  fun ref allow_tls_v1(state: Bool) =&gt;
    &quot;&quot;&quot;
    Allow TLS v1. Defaults to false.
    Deprecated: use set_min_proto_version and set_max_proto_version
    &quot;&quot;&quot;
    if not _ctx.is_null() then
      if state then
        _clear_options(_SslOpNoTlsV1())
      else
        _set_options(_SslOpNoTlsV1())
      end
    end

  fun ref allow_tls_v1_1(state: Bool) =&gt;
    &quot;&quot;&quot;
    Allow TLS v1.1. Defaults to false.
    Deprecated: use set_min_proto_version and set_max_proto_version
    &quot;&quot;&quot;
    if not _ctx.is_null() then
      if state then
        _clear_options(_SslOpNoTlsV1u1())
      else
        _set_options(_SslOpNoTlsV1u1())
      end
    end

  fun ref allow_tls_v1_2(state: Bool) =&gt;
    &quot;&quot;&quot;
    Allow TLS v1.2. Defaults to true.
    Deprecated: use set_min_proto_version and set_max_proto_version
    &quot;&quot;&quot;
    if not _ctx.is_null() then
      if state then
        _clear_options(_SslOpNoTlsV1u2())
      else
        _set_options(_SslOpNoTlsV1u2())
      end
    end

  fun ref dispose() =&gt;
    &quot;&quot;&quot;
    Free the SSL context.
    &quot;&quot;&quot;
    if not _ctx.is_null() then
      @SSL_CTX_free(_ctx)
      _ctx = Pointer[_SSLContext]
    end

  fun _final() =&gt;
    &quot;&quot;&quot;
    Free the SSL context.
    &quot;&quot;&quot;
    if not _ctx.is_null() then
      @SSL_CTX_free(_ctx)
    end


struct _CertContext
  var dwCertEncodingType: U32 = 0
  var pbCertEncoded: Pointer[U8] = Pointer[U8]
  var cbCertEncoded: U32 = 0

</code></pre>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
    <script src="../../../assets/javascripts/application.cb37bb38.js"></script>
      
      <script>app.initialize({version:"1.2.3",url:{base:"../../.."}})</script>
      
    
    
      
    
  </body>
</html>